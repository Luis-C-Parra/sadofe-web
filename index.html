<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üè• Registro SADOFE</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    /* === SPLASH SCREEN === */
    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f0f8ff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.8s ease-out;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    #splash.fade-out {
      opacity: 0;
    }
    #splash .icono {
      font-size: 90px;
      color: #e74c3c;
      margin-bottom: 20px;
    }
    #splash h1 {
      font-size: 42px;
      color: #0a3d62;
      text-align: center;
      margin: 0 30px 15px;
      line-height: 1.3;
      font-weight: bold;
    }
    #splash p {
      font-size: 16px;
      color: #555;
      margin: 0;
      position: absolute;
      bottom: 40px;
      left: 0;
      width: 100%;
      text-align: center;
    }

    /* === LOGIN SCREEN === */
    #login {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      padding: 20px;
    }
    #login form {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    #login h3 {
      text-align: center;
      color: #0a3d62;
      margin-bottom: 20px;
    }
    #login input {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }
    #login button {
      background: #0a3d62;
      color: white;
      border: none;
      padding: 12px;
      width: 100%;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    #login button:hover {
      background: #072f49;
    }

#login .cargando {
      text-align: center;
      color: #0a3d62;
      margin-top: 15px;
      font-style: italic;
    }
    #login .cargando .mate {
      font-size: 24px;
      margin-right: 8px;
    }

    /* === ESTILO PRINCIPAL === */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 25px;
    }
    h2 {
      text-align: center;
      color: #0a3d62;
      margin-bottom: 20px;
      font-size: 26px;
    }
    .form-group {
      margin-bottom: 18px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: #0a3d62;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      transition: border 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #0a3d62;
    }
    .card {
      border: 1px solid #e0e0e0;
      padding: 18px;
      margin-bottom: 18px;
      background-color: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.08);
    }
    .input-group {
      margin-bottom: 12px;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
    }
    .checkbox-group label {
      background: #e3f2fd;
      padding: 7px 10px;
      border-radius: 20px;
      font-size: 14px;
      border: 1px solid #90caf9;
      font-weight: 500;
    }
    .checkbox-group input {
      margin-right: 5px;
    }
    .botones {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 25px 0 15px;
      justify-content: center;
    }
    button {
      padding: 12px 18px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      flex: 1;
      min-width: 130px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:nth-child(1) { background: #0a3d62; color: white; }
    button:nth-child(2) { background: #007BFF; color: white; }
    button:nth-child(3) { background: #9fd6ab; color: black; }
    button:nth-child(4) { background: #f2ab6f; color: black; }
    button:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    /* ‚úÖ Estilo del resumen para la imagen */
    #resumenImagen {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
      font-family: 'Segoe UI', sans-serif;
      font-size: 16px;
      color: #000;
      max-width: 700px;
      margin: 0 auto;
    }
    #resumenImagen h3 {
      text-align: center;
      color: #0a3d62;
      margin-bottom: 18px;
      font-size: 20px;
    }
    #resumenImagen .cama {
      font-weight: bold;
      color: #0a3d62;
    }
    #resumenImagen .separador {
      border-top: 1px dashed #aaa;
      margin: 15px 0;
    }
    #imagenGenerada {
      display: block;
      margin: 20px auto;
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #modalImagen {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      padding: 20px;
    }
    .modal-content {
      background: white;
      margin: auto;
      padding: 25px;
      border-radius: 12px;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .notas-piso {
      background: #f0f8ff;
      border-left: 6px solid #0a3d62;
      padding: 18px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .notas-piso h3 {
      margin: 0 0 12px;
      color: #0a3d62;
      font-size: 18px;
    }
    .notas-piso textarea {
      min-height: 100px;
    }
  </style>
</head>
<body>

  <!-- ‚úÖ VENTANA SPLASH -->
  <div id="splash">
    <div class="icono">ü©∫</div>
    <h1>Registro de Novedades<br><br> Enfermer√≠a</h1>
    <p>¬© Lic. Luis C. Parra</p>
  </div>

  <!-- ‚úÖ VENTANA LOGIN -->
  <div id="login">
    <form id="formLogin">
      <h3>üîê Inicio de Sesi√≥n</h3>
      <label for="dni">DNI (Usuario y Contrase√±a):</label>
      <input type="text" id="dni" placeholder="Ej: 30123456" required />
      <button type="submit">Ingresar</button>
      <div id="cargando" style="display: none;" class="cargando">
        <span class="mate">üßâ</span> Verificando... Mientras, tomate un mate
      </div>
    </form>
  </div>

  <!-- ‚úÖ CONTENIDO PRINCIPAL -->
  <div class="container">
    <h2>üë©‚Äç‚öïÔ∏è Registro de Novedades - SADOFE</h2>

    <div class="form-group">
      <label for="enfermero">üë®‚Äç‚öïÔ∏è Nombre del Enfermero/a:</label>
      <input type="text" id="enfermero" readonly />
    </div>

    <div class="form-group">
      <label for="piso">üè¢ Seleccionar Piso:</label>
      <select id="piso">
        <option value="">-- Elegir piso --</option>
        <option value="1B">1B (101‚Äì110)</option>
        <option value="2B">2B (201‚Äì210)</option>
        <option value="1C">1C (116‚Äì129)</option>
        <option value="2C">2C (216‚Äì229)</option>
        <option value="3C">3C (316‚Äì322)</option>
        <option value="4C">4C (422‚Äì429)</option>
      </select>
    </div>

    <div id="tarjetasContainer"></div>

    <!-- Notas del piso -->
    <div class="notas-piso">
      <h3>üìå Notas del Piso</h3>
      <textarea id="notasPiso" placeholder="Escriba observaciones generales del piso..."></textarea>
    </div>

    <div class="botones">
      <button onclick="generarTarjetas()"><span>üìù</span> Ver Camas de Piso Elegido</button>
      <button onclick="registrar()"><span>üì§</span> Datos al Servidor</button>
      <button onclick="abrirModal()"><span>üì∑</span> Generar Novedades</button>
      <button onclick="descargarImagen()" style="display:none;" id="btnDescargar"><span>üì•</span> Descargar Imagen</button>
      <button onclick="compartirImagen()" style="display:none;" id="btnCompartir"><span>üì§</span> Compartir</button>
    </div>

    <img id="imagenGenerada" style="display:none;" />
  </div>

  <!-- Modal para seleccionar camas -->
  <div id="modalImagen">
    <div class="modal-content">
      <h3>Seleccionar camas para incluir en la imagen de novedades</h3>
      <div id="listaCamas"></div>
      <button onclick="generarImagen()">üìùGenerar Imagen</button>
      <button onclick="cerrarModal()">‚ùåCancelar</button>
    </div>
  </div>

  <!-- Contenedor oculto para el resumen -->
  <div id="resumenImagen" style="display:none;"></div>

  <script>
    // ‚úÖ Mostrar splash por 3 segundos
    window.onload = function() {
      setTimeout(() => {
        document.getElementById('splash').classList.add('fade-out');
        setTimeout(() => {
          document.getElementById('splash').style.display = 'none';
          // Mostrar login despu√©s del splash
          document.getElementById('login').style.display = 'flex';
        }, 800);
      }, 3000);
    };

    // ‚úÖ Autenticaci√≥n con Google Sheets
    document.getElementById('formLogin').addEventListener('submit', function(e) {
      e.preventDefault();
      const dni = document.getElementById('dni').value.trim();
      if (!dni) return;

const btn = e.target.querySelector('button');
      const cargando = document.getElementById('cargando');

      // ‚úÖ Mostrar mensaje amable
      btn.style.display = 'none';
      cargando.style.display = 'block';

      // Llamar a tu Google Apps Script
      fetch(`https://script.google.com/macros/s/AKfycbwBqfRagEUrSM9f9x1WvgLDKByfvfp-VPsDdUjuCNLKiUBcLO1Xb3pYlJ-qDxO_keFY3A/exec?dni=${dni}`)
        .then(res => res.json())
        .then(data => {
          if (data.valido) {
            document.getElementById('enfermero').value = data.nombre;
            document.getElementById('login').style.display = 'none';

            // Preguntar si hay otros enfermeros
            const otros = confirm(`¬øHay otros enfermeros en el piso?\n${data.nombre} (Ud.)`);
            if (otros) {
              const nombres = prompt("Ingrese los nombres de los otros enfermeros, separados por coma:");
              if (nombres) {
                localStorage.setItem('enfermerosPiso', nombres.trim());
              }
            } else {
              localStorage.removeItem('enfermerosPiso');
            }

            // Recuperar datos guardados
            const savedPiso = localStorage.getItem('sadofe_piso');
            if (savedPiso) {
              document.getElementById('piso').value = savedPiso;
              generarTarjetas();
            }
            const savedNotas = localStorage.getItem('sadofe_notas_piso');
            if (savedNotas) {
              document.getElementById('notasPiso').value = savedNotas;
            }
          } else {
            alert("‚ùå DNI no v√°lido o no autorizado.");
          }
        })
        .catch(err => {
          alert("‚ùå Error al verificar credenciales. Intente nuevamente.");
          console.error(err);
        });
    });

    const camasPorPiso = {
      "1B": generarCamas(101, 110, [110], 3),
      "2B": generarCamas(201, 210, [210], 3),
      "4B": generarCamas(402, 409),
      "1C": generarCamas(116, 129),
      "2C": generarCamas(216, 229),
      "3C": generarCamas(316, 322),
      "4C": generarCamas(422, 429, [], 2)
    };

    const opcionesNovedades = [
      "Sonda vesical", "Drenaje pleural", "Acceso Venoso Perif√©rico", "Acceso Venoso Central",
      "Drenaje aspirativo", "Drenaje percut√°neo", "Contenci√≥n f√≠sica", "Rechazo terap√©utico",
      "Deambula", "Usa pa√±ales", "L√∫cido", "Desorientado", "Somnoliento"
    ];

    function generarCamas(desde, hasta, especiales = [], camasEspecial = 2) {
      let lista = [];
      for (let i = desde; i <= hasta; i++) {
        const cantidad = especiales.includes(i) ? camasEspecial : 2;
        for (let j = 1; j <= cantidad; j++) {
          lista.push(`${i}-${j}`);
        }
      }
      return lista;
    }

    function generarTarjetas() {
      const piso = document.getElementById("piso").value;
      const contenedor = document.getElementById("tarjetasContainer");
      contenedor.innerHTML = "";

      if (!piso || !camasPorPiso[piso]) return;

      localStorage.setItem('sadofe_piso', piso);

      camasPorPiso[piso].forEach(cama => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h3>Cama ${cama}</h3>
          <div class="input-group">
            <label><strong>üõèÔ∏è Apellido y Nombre:</strong></label>
            <input type="text" placeholder="Ej: GONZ√ÅLEZ, MARTA" class="nombre" />
          </div>
          <div class="input-group">
            <label><strong>üß™ ¬øAislamiento?</strong></label>
            <select class="aislamiento">
              <option value="Ninguno">Ninguno</option>
              <option value="Respiratorio">Respiratorio</option>
              <option value="Contacto">Contacto</option>
              <option value="Neutrop√©nico">Neutrop√©nico</option>
            </select>
          </div>
          <div class="checkbox-group">
            ${opcionesNovedades.map(nov => `<label><input type="checkbox" value="${nov}">${nov}</label>`).join("")}
          </div>
          <div class="input-group">
            <label><strong>üìù Observaciones:</strong></label>
            <textarea rows="2" placeholder="Observaciones adicionales..." class="observaciones"></textarea>
          </div>
        `;
        contenedor.appendChild(card);

        const savedData = localStorage.getItem(`sadofe_cama_${cama}`);
        if (savedData) {
          const data = JSON.parse(savedData);
          const inputs = card.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            if (input.type === 'checkbox') {
              input.checked = data.novedades?.includes(input.value) || false;
            } else {
              input.value = data[input.className] || '';
            }
          });
        }

        card.querySelectorAll('input, select, textarea').forEach(input => {
          input.addEventListener('change', () => {
            const inputs = card.querySelectorAll('input, select, textarea');
            const data = {};
            inputs.forEach(inp => {
              if (inp.type === 'checkbox') {
                if (!data.novedades) data.novedades = [];
                if (inp.checked) data.novedades.push(inp.value);
              } else {
                data[inp.className] = inp.value;
              }
            });
            localStorage.setItem(`sadofe_cama_${cama}`, JSON.stringify(data));
          });
        });

        const nombreInput = card.querySelector('.nombre');
        nombreInput.addEventListener('input', () => {
          nombreInput.value = nombreInput.value.toUpperCase();
        });
      });

      const savedNotas = localStorage.getItem('sadofe_notas_piso');
      if (savedNotas) {
        document.getElementById('notasPiso').value = savedNotas;
      }
    }

    document.getElementById('notasPiso').addEventListener('input', function() {
      localStorage.setItem('sadofe_notas_piso', this.value);
    });

    function registrar() {
      const enfermero = document.getElementById("enfermero").value.trim();
      const piso = document.getElementById("piso").value;
      if (!enfermero || !piso) {
        alert("Complete el nombre del enfermero y seleccione un piso.");
        return;
      }

      const tarjetas = document.querySelectorAll(".card");
      const datos = [];

      tarjetas.forEach(card => {
        const cama = card.querySelector("h3").textContent.replace("Cama ", "");
        const nombre = card.querySelector(".nombre").value.trim();
        const aislamiento = card.querySelector(".aislamiento").value;
        const observaciones = card.querySelector(".observaciones").value.trim();
        const novedades = [...card.querySelectorAll("input[type=checkbox]")]
          .filter(chk => chk.checked).map(chk => chk.value).join(", ");

        if (!nombre && !observaciones && !novedades) return;

        datos.push({
          fecha: new Date().toLocaleString("es-AR"),
          piso,
          cama,
          nombre,
          aislamiento,
          novedades,
          observaciones,
          enfermero
        });
      });

      const notasPiso = document.getElementById("notasPiso").value.trim();
      if (notasPiso) {
        datos.push({
          fecha: new Date().toLocaleString("es-AR"),
          piso,
          cama: "NOTAS DE PISO",
          nombre: "N/A",
          aislamiento: "N/A",
          novedades: "N/A",
          observaciones: notasPiso,
          enfermero
        });
      }

      if (datos.length === 0) {
        alert("No se completaron datos para enviar.");
        return;
      }

      fetch("https://script.google.com/macros/s/AKfycbznONc4J-i6p4yuEfW5hcR8hgnbotrqJZVCrMtACl1YS7sKP7vB2BA39lXBLYBSJ6uUxQ/exec", {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      }).then(() => {
        alert("‚úÖ Novedades enviadas correctamente.");
      }).catch(err => {
        alert("‚ùå Error al enviar: " + err.message);
      });
    }

    function abrirModal() {
  const modal = document.getElementById("modalImagen");
  const lista = document.getElementById("listaCamas");
  lista.innerHTML = "";

  const piso = document.getElementById("piso").value;
  if (!piso || !camasPorPiso[piso]) return;

  const camas = camasPorPiso[piso];

  // Agrupar por habitaci√≥n
  const habitaciones = {};
  camas.forEach(cama => {
    const num = cama.split('-')[0];
    if (!habitaciones[num]) habitaciones[num] = [];
    habitaciones[num].push(cama);
  });

  // Ordenar habitaciones
  const habitacionesOrdenadas = Object.keys(habitaciones).sort((a, b) => a - b);

  habitacionesOrdenadas.forEach(num => {
    const camasHab = habitaciones[num];
    const fila = document.createElement("div");
    fila.style.display = "flex";
    fila.style.justifyContent = "space-between";
    fila.style.gap = "20px";
    fila.style.margin = "8px 0";
    fila.style.width = "100%";

    camasHab.forEach(cama => {
      const card = [...document.querySelectorAll('.card')]
        .find(c => c.querySelector('h3')?.textContent.trim() === `Cama ${cama}`);
      const nombre = card ? card.querySelector('.nombre').value.trim() || '___' : '___';

      const contenedor = document.createElement("div");
      contenedor.style.flex = "1";
      contenedor.style.minWidth = "200px";

      contenedor.innerHTML = `
        <label style="display: flex; align-items: center; font-size: 14px; cursor: pointer;">
          <input type='checkbox' value='${cama}' style="margin-right: 8px;">
          <strong>${cama}:</strong> ${nombre}
        </label>
      `;
      fila.appendChild(contenedor);
    });

    if (camasHab.length === 1) {
      const vacio = document.createElement("div");
      vacio.style.flex = "1";
      fila.appendChild(vacio);
    }

    lista.appendChild(fila);
  });

  modal.style.display = "block";
}

    function cerrarModal() {
      document.getElementById("modalImagen").style.display = "none";
    }

    function generarImagen() {
  const enfermero = document.getElementById("enfermero").value.trim();
  const piso = document.getElementById("piso").value;
  if (!enfermero || !piso) {
    alert("üë©‚Äç‚öïÔ∏è Complete el nombre del enfermero (a) y seleccione un piso.");
    return;
  }

  const checkboxes = document.querySelectorAll("#listaCamas input[type='checkbox']:checked");
  const camasSeleccionadas = Array.from(checkboxes).map(cb => cb.value);

  if (camasSeleccionadas.length === 0) {
    alert("Seleccione al menos una cama para generar la imagen.");
    return;
  }

  // ‚úÖ HTML bien estructurado y centrado
  let contenido = `
    <h3>üìã Resumen de Novedades</h3>
    <p><strong>üìÖ Fecha:</strong> ${new Date().toLocaleString("es-AR")}</p>
    <p><strong>üè¢ Piso:</strong> ${piso}</p>
    <p><strong>üë®‚Äç‚öïÔ∏è Enfermero (a):</strong> ${enfermero}</p>
  `;

  // Agregar otros enfermeros si los hay
  const otrosEnfermeros = localStorage.getItem('enfermerosPiso');
  if (otrosEnfermeros) {
    contenido += `<p><strong>üë• Otros enfermeros (as):</strong> ${otrosEnfermeros}</p>`;
  }

  contenido += `<div class="separador"></div>`;

  const tarjetas = document.querySelectorAll(".card");
  let datosIncluidos = false;

  camasSeleccionadas.forEach(camaSel => {
    const card = [...tarjetas].find(c => c.querySelector("h3").textContent.replace("Cama ", "") === camaSel);
    if (!card) return;
    const nombre = card.querySelector(".nombre").value.trim();
    const aislamiento = card.querySelector(".aislamiento").value;
    const observaciones = card.querySelector(".observaciones").value.trim();
    const novedades = [...card.querySelectorAll("input[type=checkbox]")]
      .filter(chk => chk.checked).map(chk => chk.value).join(", ");

    if (!nombre && !observaciones && !novedades) return;

    datosIncluidos = true;

    contenido += `
      <p><strong class="cama">üõèÔ∏è Cama ${camaSel}</strong>: ${nombre}`;
    if (aislamiento !== "Ninguno") contenido += ` | üß™ Aislamiento: ${aislamiento}`;
    if (novedades) contenido += ` | üìå ${novedades}`;
    if (observaciones) contenido += ` | üìù Obs: ${observaciones}`;
    contenido += `</p>
      <div class="separador"></div>`;
  });

  const notasPiso = document.getElementById("notasPiso").value.trim();
  if (notasPiso) {
    contenido += `<p><strong>üìå Notas del Piso:</strong><br>${notasPiso}</p>`;
  }

  if (!datosIncluidos && !notasPiso) {
    alert("No hay datos para las camas seleccionadas ni notas del piso.");
    return;
  }

  const contenedorResumen = document.getElementById("resumenImagen");
  contenedorResumen.innerHTML = contenido;
  contenedorResumen.style.display = "block";
  contenedorResumen.style.width = "600px"; // ‚úÖ Ancho fijo
  contenedorResumen.style.margin = "0 auto";
  contenedorResumen.style.boxSizing = "border-box";

  // ‚úÖ Captura con configuraci√≥n fija
  html2canvas(contenedorResumen, {
    backgroundColor: "#ffffff",
    scale: 2,
    useCORS: true,
    width: 600,
    height: contenedorResumen.scrollHeight + 40,
    scrollY: 0,
    windowWidth: 600,
    windowHeight: contenedorResumen.scrollHeight + 100,
    logging: false
  }).then(canvas => {
    const img = document.getElementById("imagenGenerada");
    img.src = canvas.toDataURL("image/png");
    img.style.display = "block";

    const btnDescargar = document.getElementById("btnDescargar");
    btnDescargar.style.display = "inline-flex";

    const btnCompartir = document.getElementById("btnCompartir");
    btnCompartir.style.display = "inline-flex";

    canvas.toBlob(blob => {
      const file = new File([blob], "novedades.png", { type: "image/png" });
      btnCompartir.onclick = () => {
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({ files: [file] }).catch(() => alert("Error al compartir"));
        } else {
          alert("Tu navegador no soporta compartir archivos.");
        }
      };
    });
    cerrarModal();
  });
}

    function descargarImagen() {
      const link = document.createElement("a");
      link.download = "novedades.png";
      link.href = document.getElementById("imagenGenerada").src;
      link.click();
    }

    function compartirImagen() {}
  </script>
</body>
</html>