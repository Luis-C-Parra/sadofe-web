<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SADOFE - Registro de Novedades</title>
    <meta name="theme-color" content="#0a3d62">
    <link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SADOFE">
<link rel="apple-touch-icon" href="icon-192.png">3Ccircle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%230a3d62%22/%3E%3Ctext x=%2250%22 y=%2260%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22white%22%3Eü©∫%3C/text%3E%3C/svg%3E','sizes':'192x192','type':'image/svg+xml'}]}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0a3d62 0%, #1e3c72 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
            text-align: center;
            padding: 40px 20px;
            box-sizing: border-box;
        }
        .splash-logo {
            font-size: 5.5rem;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        .splash-title {
            color: white;
            font-size: 3.5rem;
            margin-bottom: 10px;
            font-weight: 300;
            line-height: 1.2;
        }
        .splash-subtitle {
            color: #b8d4f0;
            font-size: 2rem;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .splash-subtitle2 {
            color: #b8d4f0;
            font-size: 1.8rem;
            margin-bottom: 20px;
            line-height: 1.3;
        }
        .splash-footer {
            position: static;
            bottom: 20px;
            left: 0;
            right: 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            text-align: center;
            padding: 0 20px;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        /* Login Screen */
        .login-screen {
            display: none;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
        }
        .login-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .login-card h2 {
            color: #0a3d62;
            margin-bottom: 25px;
            font-weight: 400;
            font-size: 1.5rem;
        }
        .input-group {
            margin-bottom: 18px;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
            font-size: 0.95rem;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #0a3d62;
            box-shadow: 0 0 0 3px rgba(10,61,98,0.1);
        }
        /* Botones con colores suaves */
        .btn {
            background: #1a5276;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 4px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover {
            background: #2874a6;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(40,116,166,0.25);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #27ae60;
        }
        .btn-secondary:hover {
            background: #2ecc71;
        }
        .btn-warning {
            background: #d35400;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .btn-info {
            background: #2980b9;
        }
        .btn-info:hover {
            background: #3498db;
        }
        .loading-message {
            display: none;
            text-align: center;
            margin-top: 15px;
            color: #0a3d62;
            font-style: italic;
            font-size: 0.95rem;
        }
        .solicitud-link {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #0a3d62;
            cursor: pointer;
            text-decoration: underline;
        }
        /* Main App */
        .main-app {
            display: none;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .app-header {
            background: #1a5276;
            color: white;
            padding: 18px;
            text-align: center;
        }
        .app-header h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            font-weight: 300;
        }
        .piso-display {
            background: #007bff;
            color: white;
            font-size: 1.8rem;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .nurse-info {
            background: rgba(255,255,255,0.15);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .app-content {
            padding: 20px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            align-items: end;
        }
        .controls > div {
            flex: 1;
            min-width: 180px;
        }
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            justify-content: center;
        }
        /* Camas Grid */
        .camas-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .cama-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
            position: relative;
        }
        .cama-card.aislamiento-respiratorio {
            border-color: #f39c12;
            background: #fef9f3;
        }
        .cama-card.aislamiento-contacto {
            border-color: #27ae60;
            background: #f7fdf8;
        }
        .cama-card.aislamiento-neutropenico {
            border-color: #c0392b;
            background: #fdf3f3;
        }
        .cama-card.aislamiento-psiquiatrico {
            border-color: #007bff;
            background: #e3f2fd;
        }
        .cama-header {
            background: #1a5276;
            color: white;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin: 12px 0;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9rem;
        }
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }
        .checkbox-item label {
            cursor: pointer;
        }
        .aislamiento-selector {
            margin: 12px 0;
        }
        .aislamiento-selector select {
            background-color: white;
        }
        .observaciones {
            margin-top: 12px;
        }
        .observaciones textarea {
            min-height: 60px;
            resize: vertical;
            font-size: 0.95rem;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }
        .close {
            font-size: 26px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        .cama-selection {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .cama-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        .cama-option:hover {
            border-color: #0a3d62;
        }
        .cama-option.selected {
            border-color: #0a3d62;
            background: rgba(10,61,98,0.1);
        }
        .cama-option input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        /* Resumen para imagen */
        .resumen-imagen {
            display: none;
            background: white;
            padding: 16px;
            font-family: 'Segoe UI', sans-serif;
            color: #000;
            font-size: 14px;
            line-height: 1.5;
            max-width: 400px;
            margin: 0 auto;
            box-sizing: border-box;
            text-align: center;
        }
        .resumen-header {
            text-align: center;
            border-bottom: 2px solid #0a3d62;
            padding-bottom: 10px;
            margin-bottom: 12px;
        }
        .resumen-header h1 {
            color: #0a3d62;
            font-size: 1.4rem;
            margin-bottom: 4px;
            font-weight: 300;
        }
        .resumen-info {
            margin-bottom: 12px;
            font-size: 0.9rem;
            text-align: left;
        }
        .info-item {
            margin-bottom: 4px;
        }
        .info-label {
            font-weight: bold;
            color: #0a3d62;
        }
        .cama-resumen {
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-align: left;
            page-break-inside: avoid;
        }
        .cama-resumen h3 {
            color: #0a3d62;
            margin-bottom: 4px;
            font-size: 1.05rem;
        }
        .novedades-list {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 3px 0;
        }
        .novedad-tag {
            background: #0a3d62;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        .notas-piso {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 12px;
            font-size: 0.9rem;
            text-align: left;
        }
        .notas-piso h3 {
            color: #856404;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .controls { flex-direction: column; }
            .camas-container { grid-template-columns: 1fr; }
            .checkbox-group { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .btn { justify-content: center; }
            .resumen-imagen { padding: 14px; font-size: 13px; }
            .splash-title { font-size: 2.5rem; }
            .splash-subtitle { font-size: 1.6rem; }
            .splash-subtitle2 { font-size: 1.4rem; }
            .piso-display { font-size: 1.5rem; }
        }
        .fade-out {
            opacity: 0 !important;
        }
    </style>
</head>

<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-logo">ü©∫</div>
        <h1 class="splash-title">SADOFE</h1>
        <p class="splash-subtitle">Sistema de Registro de Novedades</p>
        <p class="splash-subtitle2">Enfermer√≠a</p>
        <p class="splash-footer">¬© Lic. Luis C. Parra</p>
    </div>

    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h2>üîê Iniciar Sesi√≥n</h2>
            <div class="input-group">
                <label for="dniInput">N√∫mero de DNI:</label>
                <input type="text" id="dniInput" placeholder="Ingrese su DNI">
            </div>
            <button class="btn" onclick="login()">
                üßë‚Äç‚öïÔ∏è Iniciar Sesi√≥n
            </button>
            <div class="loading-message" id="loadingMessage">
                ‚è≥ Verificando... Mientras, tomate un mate ‚òï<br>
                 o fijate si la gotita no cae
            </div>
            <p class="solicitud-link" onclick="solicitarAccesoPorWhatsApp()">
                ¬øEres nuevo? Solicita acceso por WhatsApp
            </p>
            <div id="otherNursesSection" style="display: none; margin-top: 15px;">
                <div class="input-group">
                    <label for="otherNurses">¬øHay otros enfermeros/as en el piso?</label>
                    <textarea id="otherNurses" placeholder="Nombres separados por coma (opcional)" rows="2"></textarea>
                </div>
                <button class="btn btn-secondary" onclick="completeLogin()">
                    ‚úÖ Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="main-app" id="mainApp">
        <div class="app-header">
            <h1>ü©∫ SADOFE - Registro de Novedades</h1>
            <h1>ü©∫ E N F E R M E R I A</h1>
            <div class="nurse-info">
                <div><strong>üßë‚Äç‚öïÔ∏è Enfermera/o:</strong> <span id="nurseNameDisplay"></span></div>
                <div id="otherNursesDisplay" style="display: none;">
                    <strong>üë• Enfermeros (as):</strong> <span id="otherNursesText"></span>
                </div>
            </div>
        </div>
        <div class="app-content">
            <div class="controls">
                <div class="input-group">
                    <label for="pisoSelect">Seleccionar Piso:</label>
                    <select id="pisoSelect" onchange="handlePisoChange()">
                        <option value="">Seleccione un piso</option>
                        <option value="1B">1B (101-110)</option>
                        <option value="2B">2B (201-210)</option>
                        <option value="4B">4B (402-409)</option>
                        <option value="1C">1C (116-129)</option>
                        <option value="2C">2C (216-229)</option>
                        <option value="3C">3C (316-322)</option>
                        <option value="4C">4C (422-429)</option>
                    </select>
                </div>
            </div>

            <!-- N√∫mero de piso grande y visible -->
            <div id="pisoDisplay" class="piso-display" style="display: none;">
                PISO: <span id="pisoNumber">--</span>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="loadCamas()">
                    üè• Ver Camas del PISO Seleccionado
                </button>
                <button class="btn btn-warning" onclick="enviarDatos()">
                    üì§ Enviar datos al Servidor
                </button>
                <button class="btn btn-secondary" onclick="abrirModalNovedades()">
                    üìã Generar NOVEDADES
                </button>
            </div>
            <div class="input-group">
                <label for="notasPiso">üìù Notas del Piso:</label>
                <textarea id="notasPiso" placeholder="Estudios, pases internos, altas, etc." rows="3"></textarea>
            </div>
            <div class="camas-container" id="camasContainer">
                <!-- Camas generadas aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- Modal para Seleccionar Camas -->
    <div id="modalNovedades" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Seleccionar Camas</h2>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            <p>Seleccione las camas marcadas como "Mandar a novedad":</p>
            <div class="cama-selection" id="camaSelection"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-info" onclick="generarImagen()">üñºÔ∏è Imagen</button>
                <button class="btn btn-secondary" onclick="enviarPorWhatsApp()">üí¨ WhatsApp</button>
                <button class="btn" onclick="copiarNovedades()">üìã Copiar</button>
                <button class="btn" onclick="cerrarModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Imagen Generada -->
    <div id="imagenGenerada" style="display: none; text-align: center; margin-top: 20px;">
        <h3>üì∏ Imagen Generada</h3>
        <canvas id="canvasImagen"></canvas>
        <div style="margin-top: 12px;">
            <button class="btn btn-info" onclick="descargarImagen()">üíæ Descargar</button>
            <button class="btn btn-secondary" onclick="compartirImagen()">üì± Compartir</button>
        </div>
    </div>

    <!-- Resumen oculto para imagen -->
    <div class="resumen-imagen" id="resumenImagen"></div>

    <script>
        const CONFIG = {
            LOGIN_ENDPOINT: 'https://script.google.com/macros/s/AKfycbwBqfRagEUrSM9f9x1WvgLDKByfvfp-VPsDdUjuCNLKiUBcLO1Xb3pYlJ-qDxO_keFY3A/exec',
            DATA_ENDPOINT: 'https://script.google.com/macros/s/AKfycbznONc4J-i6p4yuEfW5hcR8hgnbotrqJZVCrMtACl1YS7sKP7vB2BA39lXBLYBSJ6uUxQ/exec',
            PISOS: {
                '1B': { desde: 101, hasta: 110, especiales: [110], camas: 3 },
                '2B': { desde: 201, hasta: 210, especiales: [210], camas: 3 },
                '4B': { desde: 402, hasta: 409, especiales: [], camas: 2 },
                '1C': { desde: 116, hasta: 129, especiales: [], camas: 2, sinCamas: [126] },
                '2C': { desde: 216, hasta: 229, especiales: [], camas: 2 },
                '3C': { desde: 316, hasta: 322, especiales: [], camas: 2 },
                '4C': { desde: 422, hasta: 429, especiales: [], camas: 2 }
            }
        };

        let userData = {
            nurseName: '',
            otherNurses: '',
            currentFloor: '',
            floorNotes: '',
            camasData: {}
        };

        // Datos por piso
        let dataPorPiso = {};

        // Camas marcadas para novedades
        let camasParaNovedades = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            setupEventListeners();
            showSplashScreen();
        });

        function showSplashScreen() {
            const splash = document.getElementById('splashScreen');
            splash.style.display = 'flex';
            setTimeout(() => {
                splash.classList.add('fade-out');
                setTimeout(() => {
                    splash.style.display = 'none';
                    document.getElementById('loginScreen').style.display = 'flex';
                }, 500);
            }, 3000);
        }

        function setupEventListeners() {
            document.getElementById('dniInput').addEventListener('keypress', e => {
                if (e.key === 'Enter') login();
            });
            document.getElementById('notasPiso').addEventListener('input', () => {
                if (userData.currentFloor) {
                    dataPorPiso[userData.currentFloor] = dataPorPiso[userData.currentFloor] || {};
                    dataPorPiso[userData.currentFloor].floorNotes = document.getElementById('notasPiso').value;
                    saveData();
                }
            });
        }

        function loadSavedData() {
            try {
                const saved = JSON.parse(localStorage.getItem('sadofe_data') || '{}');
                if (saved.nurseName) userData = { ...userData, ...saved };
                if (saved.dataPorPiso) dataPorPiso = saved.dataPorPiso;
                if (saved.camasParaNovedades) {
                    camasParaNovedades = new Set(saved.camasParaNovedades);
                }
                if (userData.currentFloor) {
                    document.getElementById('pisoSelect').value = userData.currentFloor;
                    mostrarNumeroPiso(userData.currentFloor);
                }
            } catch (e) { console.log('Error al cargar datos', e); }
        }

        function saveData() {
            try {
                const dataToSave = {
                    ...userData,
                    dataPorPiso,
                    camasParaNovedades: Array.from(camasParaNovedades)
                };
                localStorage.setItem('sadofe_data', JSON.stringify(dataToSave));
            } catch (e) { console.log('Error al guardar', e); }
        }

        async function login() {
            const dni = document.getElementById('dniInput').value.trim();
            if (!dni) {
                alert('Ingrese un DNI v√°lido');
                return;
            }
            document.getElementById('loadingMessage').style.display = 'block';
            try {
                const res = await fetch(`${CONFIG.LOGIN_ENDPOINT}?dni=${dni}`);
                const data = await res.json();
                if (data.valido) {
                    userData.nurseName = data.nombre;
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('otherNursesSection').style.display = 'block';
                } else {
                    throw new Error('No autorizado');
                }
            } catch (err) {
                document.getElementById('loadingMessage').style.display = 'none';
                alert('Error: DNI no v√°lido o sin acceso.');
            }
        }

        function solicitarAccesoPorWhatsApp() {
            const nombre = prompt("üìù Para solicitar acceso, ingresa tu nombre completo:");
            if (!nombre) return;
            const dni = prompt("üî¢ Ahora ingresa tu DNI:");
            if (!dni) return;
            const numeroWhatsApp = '5491124076812';
            const mensaje = `Hola, soy ${nombre.trim()} (DNI: ${dni.trim()}).
Quiero solicitar acceso al sistema SADOFE.
¬øPuedes ayudarme?`;
            const url = `https://wa.me/${numeroWhatsApp}?text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        function completeLogin() {
            userData.otherNurses = document.getElementById('otherNurses').value.trim();
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('nurseNameDisplay').textContent = userData.nurseName;
            if (userData.otherNurses) {
                document.getElementById('otherNursesDisplay').style.display = 'block';
                document.getElementById('otherNursesText').textContent = userData.otherNurses;
            }
            saveData();
        }

        function handlePisoChange() {
            const piso = document.getElementById('pisoSelect').value;
            if (piso) {
                userData.currentFloor = piso;
                mostrarNumeroPiso(piso);
                loadCamas();
            } else {
                document.getElementById('pisoDisplay').style.display = 'none';
                document.getElementById('camasContainer').innerHTML = '';
            }
            saveData();
        }

        function mostrarNumeroPiso(piso) {
            document.getElementById('pisoNumber').textContent = piso;
            document.getElementById('pisoDisplay').style.display = 'block';
        }

        function generarCamas(config) {
            const { desde, hasta, especiales, camas, sinCamas = [] } = config;
            const camasList = [];
            for (let hab = desde; hab <= hasta; hab++) {
                if (sinCamas.includes(hab)) continue;
                const numCamas = especiales.includes(hab) ? camas : 2;
                for (let c = 1; c <= numCamas; c++) {
                    camasList.push(`${hab}-${c}`);
                }
            }
            return camasList;
        }

        function loadCamas() {
            const piso = document.getElementById('pisoSelect').value;
            if (!piso) {
                alert('Seleccione un piso');
                return;
            }
            userData.currentFloor = piso;

            dataPorPiso[piso] = dataPorPiso[piso] || {
                floorNotes: '',
                camasData: {}
            };

            document.getElementById('notasPiso').value = dataPorPiso[piso].floorNotes || '';

            const container = document.getElementById('camasContainer');
            container.innerHTML = '';
            const config = CONFIG.PISOS[piso];
            const camas = generarCamas(config);
            camas.forEach(camaId => {
                const camaCard = createCamaCard(piso, camaId);
                container.appendChild(camaCard);
            });
            saveData();
        }

        function createCamaCard(piso, camaId) {
            const data = (dataPorPiso[piso]?.camasData || {})[camaId] || {};
            const card = document.createElement('div');
            card.className = 'cama-card';

            // Aplicar clase seg√∫n aislamiento
            if (data.aislamiento === 'Respiratorio') card.classList.add('aislamiento-respiratorio');
            else if (data.aislamiento === 'Contacto') card.classList.add('aislamiento-contacto');
            else if (data.aislamiento === 'Neutrop√©nico') card.classList.add('aislamiento-neutropenico');
            else if (data.aislamiento === 'Psiqui√°trico') card.classList.add('aislamiento-psiquiatrico');

            card.innerHTML = `
                <div class="cama-header">Cama ${camaId}</div>
                <div class="input-group">
                    <label>üë§ Paciente:</label>
                    <input type="text" value="${data.paciente || ''}" onchange="updateCamaData('${piso}', '${camaId}', 'paciente', this.value.toUpperCase())" style="text-transform:uppercase">
                </div>
                <div class="aislamiento-selector">
                    <label>üîí Aislamiento:</label>
                    <select onchange="updateAislamiento('${piso}', '${camaId}', this.value)">
                        <option value="Ninguno" ${data.aislamiento === 'Ninguno' ? 'selected' : ''}>Ninguno</option>
                        <option value="Respiratorio" ${data.aislamiento === 'Respiratorio' ? 'selected' : ''}>Respiratorio</option>
                        <option value="Contacto" ${data.aislamiento === 'Contacto' ? 'selected' : ''}>Contacto</option>
                        <option value="Neutrop√©nico" ${data.aislamiento === 'Neutrop√©nico' ? 'selected' : ''}>Neutrop√©nico</option>
                        <option value="Psiqui√°trico" ${data.aislamiento === 'Psiqui√°trico' ? 'selected' : ''}>Psiqui√°trico</option>
                    </select>
                </div>

                <!-- Sondas -->
                <details>
                    <summary style="font-weight: bold; margin: 8px 0; cursor: pointer;">üîß Sonda</summary>
                    <div class="checkbox-group" style="margin-left: 16px;">
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.sonda_vesical ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'sonda_vesical', this.checked)">
                            <label>Sonda Vesical</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.sonda_3vias ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'sonda_3vias', this.checked)">
                            <label>Sonda 3 v√≠as (lavado)</label>
                        </div>
                        <details style="margin-left: 16px;">
                            <summary style="cursor: pointer;">Sonda Nasog√°strica</summary>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.sonda_ng_debito ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'sonda_ng_debito', this.checked)">
                                <label>D√©bito</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.sonda_ng_alimento ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'sonda_ng_alimento', this.checked)">
                                <label>Alimento</label>
                            </div>
                        </details>
                    </div>
                </details>

                <!-- Drenajes -->
                <details>
                    <summary style="font-weight: bold; margin: 8px 0; cursor: pointer;">üíß Drenajes</summary>
                    <div class="checkbox-group" style="margin-left: 16px;">
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.drenaje_pleural ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'drenaje_pleural', this.checked)">
                            <label>Drenaje Pleural</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.drenaje_aspirativo ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'drenaje_aspirativo', this.checked)">
                            <label>Drenaje Aspirativo</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.drenaje_percutaneo ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'drenaje_percutaneo', this.checked)">
                            <label>Drenaje Percut√°neo</label>
                        </div>
                    </div>
                </details>

                <!-- Acceso Venoso -->
                <details>
                    <summary style="font-weight: bold; margin: 8px 0; cursor: pointer;">üíâ Acceso Venoso</summary>
                    <div class="checkbox-group" style="margin-left: 16px;">
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.acceso_periferico ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'acceso_periferico', this.checked)">
                            <label>Acceso Venoso Perif√©rico</label>
                        </div>
                        <details style="margin-left: 16px;">
                            <summary style="cursor: pointer;">Acceso Venoso Central</summary>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.avc_yugular ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'avc_yugular', this.checked)">
                                <label>Yugular</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.avc_femoral ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'avc_femoral', this.checked)">
                                <label>Femoral</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.avc_subclavia ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'avc_subclavia', this.checked)">
                                <label>Subclavia</label>
                            </div>
                        </details>
                    </div>
                </details>

                <!-- Ox√≠geno -->
                <details>
                    <summary style="font-weight: bold; margin: 8px 0; cursor: pointer;">üí® Ox√≠geno</summary>
                    <div class="checkbox-group" style="margin-left: 16px;">
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.oxigeno_canula ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'oxigeno_canula', this.checked)">
                            <label>C√°nula nasal</label>
                        </div>
                        <details style="margin-left: 16px;">
                            <summary style="cursor: pointer;">M√°scara</summary>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.oxigeno_reservorio ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'oxigeno_reservorio', this.checked)">
                                <label>Reservorio</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" ${data.oxigeno_venturi ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'oxigeno_venturi', this.checked)">
                                <label>Venturi</label>
                            </div>
                        </details>
                    </div>
                </details>

                <!-- Estado -->
                <details>
                    <summary style="font-weight: bold; margin: 8px 0; cursor: pointer;">üß† Estado</summary>
                    <div class="checkbox-group" style="margin-left: 16px;">
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.estado_lucido ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'estado_lucido', this.checked)">
                            <label>L√∫cido</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.estado_somnoliento ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'estado_somnoliento', this.checked)">
                            <label>Somnoliento</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.estado_vigil ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'estado_vigil', this.checked)">
                            <label>Vigil</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" ${data.estado_comatoso ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'estado_comatoso', this.checked)">
                            <label>Comatoso</label>
                        </div>
                    </div>
                </details>

                <!-- Otros -->
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" ${data.contencion ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'contencion', this.checked)">
                        <label>Contenci√≥n f√≠sica</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" ${data.rechazo ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'rechazo', this.checked)">
                        <label>Rechazo terap√©utico</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" ${data.deambula ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'deambula', this.checked)">
                        <label>Deambula</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" ${data.paniales ? 'checked' : ''} onchange="updateCamaData('${piso}', '${camaId}', 'paniales', this.checked)">
                        <label>Usa pa√±ales</label>
                    </div>
                </div>

                <div class="observaciones">
                    <label>üìù Obs:</label>
                    <textarea onchange="updateCamaData('${piso}', '${camaId}', 'observaciones', this.value)">${data.observaciones || ''}</textarea>
                </div>

                <!-- Botones de acci√≥n -->
                <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;">
                    <button class="btn btn-warning" style="padding: 5px 8px; font-size: 10px;" onclick="registrarAlta('${piso}', '${camaId}')">üè• Alta</button>
                    <button class="btn btn-danger" style="padding: 5px 8px; font-size: 10px;" onclick="registrarObito('${piso}', '${camaId}')">‚ö∞Ô∏è √ìbito</button>
                    <button class="btn btn-info" style="padding: 5px 8px; font-size: 10px;" onclick="registrarPase('${piso}', '${camaId}')">üîÅ Pase</button>
                    <button class="btn" style="padding: 5px 8px; font-size: 10px;" onclick="mandarANovedad('${piso}', '${camaId}')">üì§ Mandar a novedad</button>
                </div>
            `;

            return card;
        }

        function updateCamaData(piso, camaId, field, value) {
            dataPorPiso[piso] = dataPorPiso[piso] || { camasData: {} };
            dataPorPiso[piso].camasData = dataPorPiso[piso].camasData || {};
            if (!dataPorPiso[piso].camasData[camaId]) dataPorPiso[piso].camasData[camaId] = {};
            dataPorPiso[piso].camasData[camaId][field] = value;
            saveData();
        }

        function updateAislamiento(piso, camaId, value) {
            dataPorPiso[piso] = dataPorPiso[piso] || { camasData: {} };
            dataPorPiso[piso].camasData = dataPorPiso[piso].camasData || {};
            if (!dataPorPiso[piso].camasData[camaId]) dataPorPiso[piso].camasData[camaId] = {};
            dataPorPiso[piso].camasData[camaId].aislamiento = value;
            saveData();

            // Actualizar color de la tarjeta
            const container = document.getElementById('camasContainer');
            const card = Array.from(container.children).find(c => {
                const header = c.querySelector('.cama-header')?.textContent || '';
                return header.includes(camaId);
            });
            if (card) {
                card.className = 'cama-card';
                if (value === 'Respiratorio') card.classList.add('aislamiento-respiratorio');
                else if (value === 'Contacto') card.classList.add('aislamiento-contacto');
                else if (value === 'Neutrop√©nico') card.classList.add('aislamiento-neutropenico');
                else if (value === 'Psiqui√°trico') card.classList.add('aislamiento-psiquiatrico');
            }
        }

        function mandarANovedad(piso, camaId) {
            const data = dataPorPiso[piso]?.camasData[camaId] || {};
            if (!data.paciente && !data.observaciones && !Object.values(data).some(v => v === true)) {
                alert('Primero debe ingresar datos en la cama');
                return;
            }

            const [habitacion, cama] = camaId.split('-');
            let texto = `üìå HAB ${habitacion}, Cama ${cama} - ${data.paciente || 'Sin paciente'}: `;
            const detalles = [];

            // Aislamiento
            if (data.aislamiento && data.aislamiento !== 'Ninguno') {
                detalles.push(`Aislamiento: ${data.aislamiento}`);
            }

            // Sondas
            if (data.sonda_vesical) detalles.push('Sonda Vesical');
            if (data.sonda_3vias) detalles.push('Sonda 3 v√≠as');
            if (data.sonda_ng_debito) detalles.push('NG D√©bito');
            if (data.sonda_ng_alimento) detalles.push('NG Alimento');

            // Drenajes
            if (data.drenaje_pleural) detalles.push('Drenaje Pleural');
            if (data.drenaje_aspirativo) detalles.push('Drenaje Aspirativo');
            if (data.drenaje_percutaneo) detalles.push('Drenaje Percut√°neo');

            // Acceso Venoso
            if (data.acceso_periferico) detalles.push('AVP');
            if (data.acceso_central) detalles.push('AVC');
            if (data.avc_yugular) detalles.push('AVC Yugular');
            if (data.avc_femoral) detalles.push('AVC Femoral');
            if (data.avc_subclavia) detalles.push('AVC Subclavia');

            // Ox√≠geno
            if (data.oxigeno_canula) detalles.push('O2 C√°nula');
            if (data.oxigeno_mascara) detalles.push('O2 M√°scara');
            if (data.oxigeno_reservorio) detalles.push('O2 Reservorio');
            if (data.oxigeno_venturi) detalles.push('O2 Venturi');

            // Estado
            if (data.estado_lucido) detalles.push('L√∫cido');
            if (data.estado_somnoliento) detalles.push('Somnoliento');
            if (data.estado_vigil) detalles.push('Vigil');
            if (data.estado_comatoso) detalles.push('Comatoso');

            // Otros
            if (data.contencion) detalles.push('Contenci√≥n');
            if (data.rechazo) detalles.push('Rechazo');
            if (data.deambula) detalles.push('Deambula');
            if (data.paniales) detalles.push('Pa√±ales');

            if (data.observaciones) detalles.push(`Obs: "${data.observaciones}"`);

            texto += detalles.join(', ');

            const notasActuales = document.getElementById('notasPiso').value || '';
            if (notasActuales.includes(texto)) {
                alert('‚ö†Ô∏è Esta informaci√≥n ya fue enviada a "Notas del Piso"');
                return;
            }

            const nuevasNotas = notasActuales ? `${notasActuales}\n${texto}` : texto;
            document.getElementById('notasPiso').value = nuevasNotas;
            dataPorPiso[piso].floorNotes = nuevasNotas;
            camasParaNovedades.add(`${piso}-${camaId}`);
            saveData();

            alert('‚úÖ Enviado a "Notas del Piso"');
        }

        function registrarAlta(piso, camaId) {
            const data = dataPorPiso[piso]?.camasData[camaId] || {};
            if (!data.paciente) {
                alert('Primero debe ingresar el nombre del paciente');
                return;
            }

            const tipo = prompt(
                `üè• ${data.paciente}\n\n¬øQu√© tipo de alta?\n\n1. Alta M√©dica\n2. Alta Voluntaria\n\nIngrese 1 o 2:`
            );

            let texto = '';
            if (tipo === '1') {
                texto = `‚úÖ ALTA M√âDICA: ${data.paciente} (Cama ${camaId})`;
            } else if (tipo === '2') {
                texto = `‚ö†Ô∏è ALTA VOLUNTARIA: ${data.paciente} (Cama ${camaId})`;
            } else if (tipo === null) {
                return;
            } else {
                alert('Opci√≥n no v√°lida');
                return;
            }

            const notasActuales = document.getElementById('notasPiso').value || '';
            if (notasActuales.includes(texto)) {
                alert('‚ö†Ô∏è Esta alta ya fue registrada');
                return;
            }

            const nuevasNotas = notasActuales ? `${notasActuales}\n${texto}` : texto;
            document.getElementById('notasPiso').value = nuevasNotas;
            dataPorPiso[piso].floorNotes = nuevasNotas;
            camasParaNovedades.add(`${piso}-${camaId}`);
            saveData();

            // Limpiar la cama
            delete dataPorPiso[piso].camasData[camaId];
            loadCamas();

            alert('‚úÖ Alta registrada y cama limpiada');
        }

        function registrarObito(piso, camaId) {
            const data = dataPorPiso[piso]?.camasData[camaId] || {};
            if (!data.paciente) {
                alert('Primero debe ingresar el nombre del paciente');
                return;
            }

            const causa = prompt(
                `‚ö∞Ô∏è ${data.paciente}\n\n¬øCausa del √≥bito?\nEj: Paro cardiorrespiratorio, Sepsis, etc.`
            );

            if (!causa) return;

            const texto = `‚ùå √ìBITO: ${data.paciente} (Cama ${camaId}) - Causa: ${causa}`;

            const notasActuales = document.getElementById('notasPiso').value || '';
            if (notasActuales.includes(texto)) {
                alert('‚ö†Ô∏è Este √≥bito ya fue registrado');
                return;
            }

            const nuevasNotas = notasActuales ? `${notasActuales}\n${texto}` : texto;
            document.getElementById('notasPiso').value = nuevasNotas;
            dataPorPiso[piso].floorNotes = nuevasNotas;
            camasParaNovedades.add(`${piso}-${camaId}`);
            saveData();

            // Limpiar la cama
            delete dataPorPiso[piso].camasData[camaId];
            loadCamas();

            alert('‚úÖ √ìbito registrado y cama limpiada');
        }

        function registrarPase(piso, camaId) {
            const data = dataPorPiso[piso]?.camasData[camaId] || {};
            if (!data.paciente) {
                alert('Primero debe ingresar el nombre del paciente');
                return;
            }

            const destinoPiso = prompt(`üîÅ ${data.paciente}\n\n¬øA qu√© piso se traslada? (ej: 1B, 2C, 4B)`).trim();
            if (!destinoPiso) return;

            const destinoHab = prompt(`üè† Habitaci√≥n destino:`).trim();
            if (!destinoHab) return;

            const destinoCama = prompt(`üõèÔ∏è Cama destino:`).trim();
            if (!destinoCama) return;

            const texto = `üîÅ PASE INTERNO: ${data.paciente} (Cama ${camaId}) ‚Üí Piso ${destinoPiso}, Hab ${destinoHab}, Cama ${destinoCama}`;

            const notasActuales = document.getElementById('notasPiso').value || '';
            if (notasActuales.includes(texto)) {
                alert('‚ö†Ô∏è Este pase ya fue registrado');
                return;
            }

            const nuevasNotas = notasActuales ? `${notasActuales}\n${texto}` : texto;
            document.getElementById('notasPiso').value = nuevasNotas;
            dataPorPiso[piso].floorNotes = nuevasNotas;
            camasParaNovedades.add(`${piso}-${camaId}`);
            saveData();

            alert('‚úÖ Pase interno registrado');
        }

        function enviarPorWhatsApp() {
            const selected = Array.from(document.querySelectorAll('#camaSelection input:checked')).map(cb => cb.id.replace('sel-', ''));
            if (selected.length === 0) {
                alert('Seleccione al menos una cama');
                return;
            }

            const piso = userData.currentFloor;
            const notasPiso = dataPorPiso[piso]?.floorNotes || '';

            let texto = `üìã *NOVEDADES DE ENFERMER√çA*\n`;
            texto += `üìÖ ${new Date().toLocaleString('es-AR')}\n`;
            texto += `üè• *Piso:* ${piso}\n`;
            texto += `üë©‚Äç‚öïÔ∏è *Enfermero/a:* ${userData.nurseName || 'No especificado'}\n`;
            if (userData.otherNurses) {
                texto += `üë• *Enfermeros (as):* ${userData.otherNurses}\n`;
            }
            texto += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;

            let hayDatos = false;

            selected.forEach((camaId) => {
                const data = dataPorPiso[piso]?.camasData[camaId] || {};
                if (!data.paciente && !data.observaciones && !Object.values(data).some(v => v === true)) return;
                hayDatos = true;

                const [habitacion, cama] = camaId.split('-');
                texto += `üè† *HAB ${habitacion}, Cama ${cama}*\n`;
                if (data.paciente) texto += `üë§ ${data.paciente}\n`;
                if (data.aislamiento && data.aislamiento !== 'Ninguno') texto += `üîπ Aislamiento: ${data.aislamiento}\n`;
                if (data.sonda_vesical) texto += `üîπ Sonda Vesical\n`;
                if (data.sonda_3vias) texto += `üîπ Sonda 3 v√≠as\n`;
                if (data.sonda_ng_debito) texto += `üîπ NG D√©bito\n`;
                if (data.sonda_ng_alimento) texto += `üîπ NG Alimento\n`;
                if (data.drenaje_pleural) texto += `üîπ Drenaje Pleural\n`;
                if (data.drenaje_aspirativo) texto += `üîπ Drenaje Aspirativo\n`;
                if (data.drenaje_percutaneo) texto += `üîπ Drenaje Percut√°neo\n`;
                if (data.acceso_periferico) texto += `üîπ Acceso Perif√©rico\n`;
                if (data.acceso_central) texto += `üîπ Acceso Central\n`;
                if (data.avc_yugular) texto += `üîπ AVC Yugular\n`;
                if (data.avc_femoral) texto += `üîπ AVC Femoral\n`;
                if (data.avc_subclavia) texto += `üîπ AVC Subclavia\n`;
                if (data.oxigeno_canula) texto += `üîπ O2 por C√°nula\n`;
                if (data.oxigeno_mascara) texto += `üîπ O2 por M√°scara\n`;
                if (data.oxigeno_reservorio) texto += `üîπ O2 Reservorio\n`;
                if (data.oxigeno_venturi) texto += `üîπ O2 Venturi\n`;
                if (data.estado_lucido) texto += `üîπ Estado: L√∫cido\n`;
                if (data.estado_somnoliento) texto += `üîπ Estado: Somnoliento\n`;
                if (data.estado_vigil) texto += `üîπ Estado: Vigil\n`;
                if (data.estado_comatoso) texto += `üîπ Estado: Comatoso\n`;
                if (data.observaciones) texto += `üìù ${data.observaciones}\n`;
                texto += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            });

            if (notasPiso) {
                hayDatos = true;
                texto += `üìå *NOTAS DEL PISO:*\n${notasPiso}\n`;
            }

            if (!hayDatos) {
                alert('No hay datos para generar');
                return;
            }

            const textoCodificado = encodeURIComponent(texto);
            const url = `https://wa.me/?text=${textoCodificado}`;
            window.open(url, '_blank');
            cerrarModal();
        }

        function copiarNovedades() {
            const selected = Array.from(document.querySelectorAll('#camaSelection input:checked')).map(cb => cb.id.replace('sel-', ''));
            if (selected.length === 0) {
                alert('Seleccione al menos una cama');
                return;
            }

            const piso = userData.currentFloor;
            const notasPiso = dataPorPiso[piso]?.floorNotes || '';

            let texto = `üìã NOVEDADES DE ENFERMER√çA\n`;
            texto += `Fecha: ${new Date().toLocaleString('es-AR')}\n`;
            texto += `Piso: ${piso}\n`;
            texto += `Enfermero/a: ${userData.nurseName || 'No especificado'}\n`;
            if (userData.otherNurses) {
                texto += `Enfermeros (as): ${userData.otherNurses}\n`;
            }
            texto += `\n--- DETALLE ---\n`;

            let hayDatos = false;

            selected.forEach((camaId) => {
                const data = dataPorPiso[piso]?.camasData[camaId] || {};
                if (!data.paciente && !data.observaciones && !Object.values(data).some(v => v === true)) return;
                hayDatos = true;

                const [habitacion, cama] = camaId.split('-');
                texto += `HAB ${habitacion}, Cama ${cama}\n`;
                if (data.paciente) texto += `Paciente: ${data.paciente}\n`;
                if (data.aislamiento && data.aislamiento !== 'Ninguno') texto += `Aislamiento: ${data.aislamiento}\n`;
                if (data.sonda_vesical) texto += `Sonda Vesical\n`;
                if (data.sonda_3vias) texto += `Sonda 3 v√≠as\n`;
                if (data.sonda_ng_debito) texto += `NG D√©bito\n`;
                if (data.sonda_ng_alimento) texto += `NG Alimento\n`;
                if (data.drenaje_pleural) texto += `Drenaje Pleural\n`;
                if (data.drenaje_aspirativo) texto += `Drenaje Aspirativo\n`;
                if (data.drenaje_percutaneo) texto += `Drenaje Percut√°neo\n`;
                if (data.acceso_periferico) texto += `Acceso Perif√©rico\n`;
                if (data.acceso_central) texto += `Acceso Central\n`;
                if (data.avc_yugular) texto += `AVC Yugular\n`;
                if (data.avc_femoral) texto += `AVC Femoral\n`;
                if (data.avc_subclavia) texto += `AVC Subclavia\n`;
                if (data.oxigeno_canula) texto += `O2 por C√°nula\n`;
                if (data.oxigeno_mascara) texto += `O2 por M√°scara\n`;
                if (data.oxigeno_reservorio) texto += `O2 Reservorio\n`;
                if (data.oxigeno_venturi) texto += `O2 Venturi\n`;
                if (data.estado_lucido) texto += `Estado: L√∫cido\n`;
                if (data.estado_somnoliento) texto += `Estado: Somnoliento\n`;
                if (data.estado_vigil) texto += `Estado: Vigil\n`;
                if (data.estado_comatoso) texto += `Estado: Comatoso\n`;
                if (data.observaciones) texto += `Observaciones: ${data.observaciones}\n`;
                texto += `--------\n`;
            });

            if (notasPiso) {
                hayDatos = true;
                texto += `Notas del piso:\n${notasPiso}\n`;
            }

            if (!hayDatos) {
                alert('No hay datos para generar');
                return;
            }

            navigator.clipboard.writeText(texto).then(() => {
                alert('‚úÖ Novedades copiadas al portapapeles. ¬°P√©gala en WhatsApp!');
                cerrarModal();
            }).catch(err => {
                console.error('Error al copiar:', err);
                alert('‚ùå No se pudo copiar. Usa la opci√≥n de WhatsApp.');
            });
        }

        function generarImagen() {
            const selected = Array.from(document.querySelectorAll('#camaSelection input:checked')).map(cb => cb.id.replace('sel-', ''));
            if (selected.length === 0) {
                alert('Seleccione al menos una cama');
                return;
            }
            const resumen = document.getElementById('resumenImagen');
            resumen.innerHTML = '';

            let contenidoHTML = `
                <div style="background: #0a3d62; color: white; padding: 12px; margin: -16px -16px 12px -16px; text-align: center;">
                    <h1 style="margin: 0; font-size: 16px; font-weight: bold;">üìã NOVEDADES DE ENFERMER√çA</h1>
                </div>
                <div style="border-bottom: 1px solid #ddd; margin-bottom: 8px;"></div>
            `;

            const piso = userData.currentFloor;
            const notasPiso = dataPorPiso[piso]?.floorNotes || '';

            contenidoHTML += `
                <div style="margin-bottom: 10px; font-size: 11px; line-height: 1.4;">
                    <div style="font-weight: bold; color: #0a3d62; margin-bottom: 4px;">üë©‚Äç‚öïÔ∏è Enfermera/o de turno:</div>
                    <div style="background: #f8f9fa; padding: 6px; border-radius: 4px; border-left: 3px solid #0a3d62;">
                        ${userData.nurseName || 'No especificado'}
                    </div>
            `;
            if (userData.otherNurses) {
                contenidoHTML += `
                    <div style="font-weight: bold; color: #0a3d62; margin-top: 8px; margin-bottom: 4px;">üë• Enfermeros (as):</div>
                    <div style="background: #f8f9fa; padding: 6px; border-radius: 4px; border-left: 3px solid #28a745;">
                        ${userData.otherNurses}
                    </div>
                `;
            }
            contenidoHTML += `</div>`;

            let hayDatos = false;
            let camasConDatos = 0;

            selected.forEach((camaId) => {
                const data = dataPorPiso[piso]?.camasData[camaId] || {};
                if (!data.paciente && !data.observaciones && !Object.values(data).some(v => v === true)) return;
                hayDatos = true;

                const [habitacion, cama] = camaId.split('-');

                // Separador entre camas
                if (camasConDatos > 0) {
                    contenidoHTML += `<div style="border-top: 1px dashed #ccc; margin: 8px 0;"></div>`;
                }
                camasConDatos++;

                contenidoHTML += `<div style="border-top: 2px solid #0a3d62; margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 8px;">`;
                contenidoHTML += `<div style="font-size: 12px; font-weight: bold; color: #0a3d62; margin-bottom: 4px;">üè† HABITACI√ìN ${habitacion} - CAMA ${cama}</div>`;

                if (data.paciente) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #e8f4f8; border-left: 3px solid #0a3d62;"><strong>üë§ PACIENTE:</strong> ${data.paciente}</div>`;
                }

                if (data.aislamiento && data.aislamiento !== 'Ninguno') {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #fff3cd; border-left: 3px solid #ffc107;"><strong>üß™ AISLAMIENTO:</strong> ${data.aislamiento}</div>`;
                }

                // Sondas
                if (data.sonda_vesical || data.sonda_3vias || data.sonda_ng_debito || data.sonda_ng_alimento) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #d1ecf1; border-left: 3px solid #17a2b8;"><strong>üîπ SONDA:</strong> `;
                    const sondas = [];
                    if (data.sonda_vesical) sondas.push('Vesical');
                    if (data.sonda_3vias) sondas.push('3 v√≠as');
                    if (data.sonda_ng_debito) sondas.push('NG D√©bito');
                    if (data.sonda_ng_alimento) sondas.push('NG Alimento');
                    contenidoHTML += sondas.join(', ') + `</div>`;
                }

                // Drenajes
                if (data.drenaje_pleural || data.drenaje_aspirativo || data.drenaje_percutaneo) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #d4edda; border-left: 3px solid #28a745;"><strong>üîπ DRENAJE:</strong> `;
                    const drenajes = [];
                    if (data.drenaje_pleural) drenajes.push('Pleural');
                    if (data.drenaje_aspirativo) drenajes.push('Aspirativo');
                    if (data.drenaje_percutaneo) drenajes.push('Percut√°neo');
                    contenidoHTML += drenajes.join(', ') + `</div>`;
                }

                // Acceso Venoso
                if (data.acceso_periferico || data.acceso_central || data.avc_yugular || data.avc_femoral || data.avc_subclavia) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #fff3cd; border-left: 3px solid #ffc107;"><strong>üîπ AVC:</strong> `;
                    const avcs = [];
                    if (data.acceso_periferico) avcs.push('Perif√©rico');
                    if (data.acceso_central) avcs.push('Central');
                    if (data.avc_yugular) avcs.push('Yugular');
                    if (data.avc_femoral) avcs.push('Femoral');
                    if (data.avc_subclavia) avcs.push('Subclavia');
                    contenidoHTML += avcs.join(', ') + `</div>`;
                }

                // Ox√≠geno
                if (data.oxigeno_canula || data.oxigeno_mascara || data.oxigeno_reservorio || data.oxigeno_venturi) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #f8f9f0; border-left: 3px solid #fd7e14;"><strong>üîπ O2:</strong> `;
                    const oxigeno = [];
                    if (data.oxigeno_canula) oxigeno.push('C√°nula');
                    if (data.oxigeno_mascara) oxigeno.push('M√°scara');
                    if (data.oxigeno_reservorio) oxigeno.push('Reservorio');
                    if (data.oxigeno_venturi) oxigeno.push('Venturi');
                    contenidoHTML += oxigeno.join(', ') + `</div>`;
                }

                // Estado
                if (data.estado_lucido || data.estado_somnoliento || data.estado_vigil || data.estado_comatoso) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #e9ecef; border-left: 3px solid #6c757d;"><strong>üìå ESTADO:</strong> `;
                    const estados = [];
                    if (data.estado_lucido) estados.push('L√∫cido');
                    if (data.estado_somnoliento) estados.push('Somnoliento');
                    if (data.estado_vigil) estados.push('Vigil');
                    if (data.estado_comatoso) estados.push('Comatoso');
                    contenidoHTML += estados.join(', ') + `</div>`;
                }

                // Otros
                const otros = [];
                if (data.contencion) otros.push('Contenci√≥n');
                if (data.rechazo) otros.push('Rechazo');
                if (data.deambula) otros.push('Deambula');
                if (data.paniales) otros.push('Pa√±ales');
                if (otros.length > 0) {
                    contenidoHTML += `<div style="font-size: 11px; margin: 2px 0; padding: 2px 6px; background: #d1ecf1; border-left: 3px solid #17a2b8;"><strong>üîπ OTROS:</strong> ${otros.join(', ')}</div>`;
                }

                if (data.observaciones) {
                    contenidoHTML += `<div style="font-size: 10px; margin: 2px 0; padding: 3px 6px; background: #f0f8ff; border-left: 3px solid #17a2b8; font-style: italic;"><strong>üìù OBS:</strong> ${data.observaciones}</div>`;
                }

                contenidoHTML += `</div>`;
            });

            if (notasPiso) {
                hayDatos = true;
                contenidoHTML += `
                    <div style="border-top: 2px solid #17a2b8; margin-top: 10px; padding-top: 6px;">
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #e9ecef;">
                            <div style="font-size: 11px; font-weight: bold; color: #17a2b8; margin-bottom: 4px;">
                                üìù NOTAS DEL PISO:
                            </div>
                            <div style="font-size: 10px; color: #333; line-height: 1.4;">
                                ${notasPiso}
                            </div>
                        </div>
                    </div>
                `;
            }

            if (!hayDatos) {
                alert('No hay datos para generar');
                return;
            }

            resumen.innerHTML = contenidoHTML;
            resumen.style.display = 'block';
            resumen.style.position = 'absolute';
            resumen.style.left = '-9999px';
            resumen.style.top = '0';
            resumen.style.width = '300px';
            resumen.style.padding = '16px';
            resumen.style.margin = '0';
            resumen.style.backgroundColor = '#ffffff';
            resumen.style.fontFamily = 'Arial, sans-serif';
            resumen.style.fontSize = '10px';
            resumen.style.lineHeight = '1.2';
            resumen.style.color = '#000000';
            resumen.style.boxSizing = 'border-box';
            resumen.style.border = '1px solid #ddd';
            resumen.style.zIndex = '-9999';

            setTimeout(() => {
                html2canvas(resumen, {
                    scale: 2,
                    width: 300,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    allowTaint: false,
                    logging: false
                }).then(canvas => {
                    resumen.style.display = 'none';
                    resumen.style.position = 'static';

                    const displayCanvas = document.getElementById('canvasImagen');
                    const optimalWidth = Math.min(300, window.innerWidth - 40);
                    displayCanvas.width = canvas.width;
                    displayCanvas.height = canvas.height;
                    displayCanvas.style.maxWidth = '100%';
                    displayCanvas.style.width = optimalWidth + 'px';
                    displayCanvas.style.height = 'auto';
                    displayCanvas.style.border = '2px solid #0a3d62';
                    displayCanvas.style.borderRadius = '8px';
                    displayCanvas.style.display = 'block';
                    displayCanvas.style.margin = '10px auto';
                    displayCanvas.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';

                    const ctx = displayCanvas.getContext('2d');
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(canvas, 0, 0);

                    document.getElementById('imagenGenerada').style.display = 'block';

                    setTimeout(() => {
                        document.getElementById('imagenGenerada').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 100);

                    cerrarModal();
                }).catch(err => {
                    console.error('Error al generar imagen:', err);
                    resumen.style.display = 'none';
                    alert('‚ùå Error al generar imagen: ' + err.message);
                });
            }, 500);
        }

        function descargarImagen() {
            const link = document.createElement('a');
            link.download = 'novedades.png';
            link.href = document.getElementById('canvasImagen').toDataURL('image/png');
            link.click();
        }

        function compartirImagen() {
            const canvas = document.getElementById('canvasImagen');
            canvas.toBlob(blob => {
                const file = new File([blob], 'novedades.png', { type: 'image/png' });
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({ files: [file] });
                } else {
                    alert('Compartir no soportado en este navegador.');
                }
            });
        }

        function abrirModalNovedades() {
            const container = document.getElementById('camaSelection');
            container.innerHTML = '';
            const piso = userData.currentFloor;
            if (!piso || !dataPorPiso[piso]) return;
            const config = CONFIG.PISOS[piso];
            const camas = generarCamas(config);
            camas.forEach(camaId => {
                const data = dataPorPiso[piso].camasData[camaId] || {};
                const estaMarcada = camasParaNovedades.has(`${piso}-${camaId}`);

                if (!estaMarcada) return;

                const div = document.createElement('div');
                div.className = 'cama-option';
                div.innerHTML = `
                    <input type="checkbox" id="sel-${camaId}" checked>
                    <label for="sel-${camaId}">Cama ${camaId} - ${data.paciente || 'Sin paciente'}</label>
                `;
                div.onclick = () => div.querySelector('input').click();
                container.appendChild(div);
            });
            if (container.children.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No hay camas marcadas</p>';
            }
            document.getElementById('modalNovedades').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalNovedades').style.display = 'none';
        }
    </script>
<script>
  // Registrar el Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('SW registrado:', reg))
        .catch(err => console.log('Error al registrar SW:', err));
    });
  }

  // Detectar si se puede instalar la PWA
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Aqu√≠ puedes mostrar un bot√≥n de "Instalar App"
    console.log('App lista para instalarse.');
  });

  // Opcional: Bot√≥n de instalaci√≥n manual
  window.instalarApp = () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(() => {
        deferredPrompt = null;
      });
    }
  };
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('SW registrado'))
        .catch(err => console.log('Error:', err));
    });
  }
</script>
</body>
</html>